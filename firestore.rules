rules_version = '2';

/**
 * Firestore Security Rules for ForgeERP ↔ Scrumboard Sync
 *
 * Deploy these rules to your Firebase project:
 *   firebase deploy --only firestore:rules
 *
 * Or paste them into the Firebase Console:
 *   https://console.firebase.google.com/project/arnout-s-homelab/firestore/rules
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // kanban-boards collection — shared scrumboard state
    match /kanban-boards/{boardId} {
      // Only authenticated users can read
      allow read: if request.auth != null;

      // Only authenticated users can write, with validation:
      // - Must have a projects array
      // - Document size must stay under 1 MB (Firestore limit safety)
      allow update: if request.auth != null
        && request.resource.data.keys().hasAny(['projects'])
        && request.resource.size() < 1048576;

      // Only admins can create or delete the board document
      allow create, delete: if request.auth != null
        && request.auth.token.email in [
          'admin@forgeerp.nl'    // Replace with your admin email(s)
        ];
    }

    // Retro presence — ephemeral user tracking
    match /retro-presence/{docId} {
      allow read: if request.auth != null;
      // Users can only write their own presence document
      allow write: if request.auth != null
        && request.auth.uid == docId;
    }

    // Retro nicknames
    match /retro-nicknames/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
